<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="common/layout/base"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Page</title>
  <style>
    body {
      input:focus {
        outline: none;
      }
    }
    .main-container,
    .main-container * {
      box-sizing: border-box;
    }
    .main-container {
      padding: 0px 280px 140px 280px;
      display: flex;
      flex-direction: column;
      gap: 0px;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      flex: 1;
    }
    .order-title {
      color: #101010;
      text-align: center;
      font-family: "Inter-Regular", sans-serif;
      font-size: 20px;
      line-height: 34px;
      font-weight: 400;
      width: 100%;
      margin: 40px 0; /* 제목이 최상단에 위치하도록 여백 추가 */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .recipient-info-section {
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: flex-start;
      justify-content: flex-start;
      width: 1000px;
      flex-shrink: 0;
      position: relative;
    }
    .section-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-top: 1px solid #101010;
      padding-top: 20px;
    }
    .section-header2 {
      border-top: 1px solid #101010;
      padding: 20px 0;
      margin-bottom: 20px;

    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
    }
    .info-table {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .info-row {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .memo-list {
      gap: 10px;
    }
    .info-label {
      width: 100px;
      font-size: 14px;
    }
    .input-field {
      border: 2px solid #cdcdcd;
      padding: 10px;
      border-radius: 3px;
      width: 300px;
    }
    .address-list {
      display: flex;
      gap: 20px;
    }
    .address-item {
      padding: 20px 0px;
      border-radius: 3px;
      width: 330px;
    }
    .product-info-section {
      width: 1000px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .product-container {
      display: flex;
      gap: 20px;
    }
    .product-item {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .item-thumbnail {
      width: 77px;
      height: 102px;
    }
    .item-description {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .item-price {
      font-weight: 700;
      font-size: 18px;
    }
    .payment-frame {
      width: 1000px;
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: space-between;
      height: 200px;
    }
    .payment-method-item {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .summary-title {
      height: 30px;
    }
    .summary-value {
      color: #101010;
      font-family: "Inter-Regular", sans-serif;
      font-size: 25px;
      font-weight: 700;
      text-align: right;
    }
    .summary-table,
    .summary-row {
      gap: 20px;
    }
    .pay-button {
      background: #062236;
      border-radius: 54px;
      width: 324px;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
    }
    .button-text {
      color: #ffffff;
      font-family: "Inter-Regular", sans-serif;
      font-size: 16.203125px;
      line-height: 54px;
      font-weight: 400;
    }
    .agreement-list {
      display: flex;
      flex-direction: column; /* 위에서 아래로 정렬 */
      gap: 15px; /* 항목 간 간격 추가 */
    }
  </style>
</head>
<body>
  <th:block layout:fragment="content">
    <div class="main-container">
      <div class="order-title">
        <h2>결제/주문</h2>
      </div>
      <section class="recipient-info-section">
        <header class="section-header">
          <h2 class="section-title">받는 분 정보</h2>
        </header>
        <div class="info-table">
          <div class="info-body">
            <!-- 이메일 주소 정보 -->
            <div class="info-row">
              <div class="info-label">이메일 주소</div>
              <input type="text" id="buyer-email" class="input-field" value="" readonly>
            </div>
            <!-- 배송지 정보 -->
            <div class="info-row">
              <div class="info-label">
                <span class="label-title">배송지 정보</span>

              </div>
              <div class="info-data">
                <div class="address-list">
                  <div>
                    <div class="address-item">
                      <button class="address-link" onclick="openAddressRegistration()">
                        <span class="link-text">배송지를 등록하세요</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- 배송 메모 -->
            <div class="info-row">
              <div class="info-label">배송 메모</div>
              <div class="info-data">
                <div class="memo-list">
                  <label class="memo-item">
                    <input type="radio" name="memo-option" class="memo-checkbox">
                    <span class="memo-text">선택 안 함</span>
                  </label>
                  <label class="memo-item">
                    <input type="radio" name="memo-option" class="memo-checkbox">
                    <span class="memo-text">부재 시 경비실에 맡겨주세요</span>
                  </label>
                  <label class="memo-item">
                    <input type="radio" name="memo-option" class="memo-checkbox">
                    <span class="memo-text">부재 시 집 앞에 놔주세요</span>
                  </label>
                  <label class="memo-item">
                    <input type="radio" name="memo-option" class="memo-checkbox">
                    <span class="memo-text">부재 시 핸드폰으로 연락 바랍니다</span>
                  </label>
                  <label class="memo-item">
                    <input type="radio" name="memo-option" class="memo-checkbox">
                    <span class="memo-text">배송 전 연락 바랍니다</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section class="product-info-section">
          <header class="section-header">
            <h2 class="section-title">상품 정보</h2>
          </header>
          <div class="product-container">
            <div th:if="${order != null and order.orderDetails != null and order.orderDetails.size() > 0}" th:each="orderDetail : ${order.orderDetails}">
                <div class="item-thumbnail">
                    <img class="thumbnail-img" th:src="@{/images/product/look1/productThumbnail.jpg}" alt="상품 이미지"/>
                </div>
                <div class="item-description">
                    <div class="brand-name" th:text="${orderDetail.productName}">브랜드명</div>
                    <div class="product-variant" th:text="${orderDetail.quantity} + '개'">수량</div>
                </div>
                <div class="item-price">
                    <strong th:text="${orderDetail.productPrice} + '원'">상품 가격</strong>
                </div>
            </div>
            <div th:if="${order == null or order.orderDetails == null or order.orderDetails.size() == 0}">
                <p>선택된 상품이 없습니다.</p>
            </div>
        </div>        
        </section>         
      </section>
        <section class="payment-frame">
          <header class="section-header2">
            <h2 class="section-title">결제수단 선택</h2>
          </header>
          <div class="payment-method-list">
            <label class="payment-method-item">
              <input type="radio" name="payment-method" class="method-radio" value="card">
              <img src="/images/icon/card-image.png" alt="Credit/Debit Card" class="method-icon">
              <span class="method-title">신용/체크카드</span>
            </label>
          </div>
          <header class="section-header2">
            <h2 class="section-title">최종 결제금액</h2>
          </header>
          <section class="total-payment-section">
            <div class="summary-table">
              <div class="agreement-section">
                <div class="agreement-list">
                  <label class="agreement-item">
                    <input type="checkbox" name="agreement1" class="agreement-checkbox">
                    <span class="agreement-text">주문상품정보 및 서비스 이용약관에 동의</span>
                  </label>
                  <label class="agreement-item">
                    <input type="checkbox" name="agreement2" class="agreement-checkbox">
                    <span class="agreement-text">구매조건 확인 및 결제 진행 동의(필수)</span>
                  </label>
                  <label class="agreement-item">
                    <input type="checkbox" name="agreement3" class="agreement-checkbox">
                    <span class="agreement-text">개인정보 제 3자 제공 동의(필수)</span>
                    <button class="details-button">자세히</button>
                  </label>
                  <label class="final-agreement">
                    <input type="checkbox" name="final-agreement" class="agreement-checkbox">
                    <span class="agreement-text">위 주문 내용을 확인하였으며, 결제에 모두 동의합니다</span>
                  </label>
                </div>
              </div>
              <div class="summary-row">
                <span class="summary-title">최종 결제금액</span>
                <span class="summary-value">0원</span>
                <button class="pay-button" id="pay-button">
                  결제하기
                </button>
              </div>
            </div>
          </section>
        </section>
      </div>
  </th:block>
  <th:block layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script>
      $(document).ready(function () {
        console.log("jQuery 로드 성공");

        // 결제하기 버튼 클릭 이벤트
        $("#pay-button").click(function () {
          console.log("결제하기 버튼 클릭됨");

          let selectedItems = [];
          let totalAmount = 0;
          let productNames = [];

          // 선택된 상품 정보 수집
          $(".product-item").each(function () {
              const productName = $(this).find(".product-name").text().trim();
              const productPrice = parseInt($(this).find(".item-price").text().replace(/\D/g, ""));
              const quantity = parseInt($(this).find(".product-variant").text().replace(/[^0-9]/g, ""));

              totalAmount += productPrice * quantity;
              productNames.push(productName);

              // 선택된 상품 정보를 배열에 추가
              selectedItems.push({
                  productName: productName,
                  productPrice: productPrice,
                  quantity: quantity
              });
          });

          let orderName = productNames.length === 1 ? productNames[0] : `${productNames[0]} 외 ${productNames.length - 1}개`;

          let buyerEmail = $("#buyer-email").val();
          let buyerName = "이유진"; // 실제로 사용자 정보를 가져와야 합니다
          let buyerTel = "01051026304"; // 실제로 사용자 정보를 가져와야 합니다
          let buyerAddr = "경기도 성남시 수정구 수정로 31"; // 실제로 사용자 정보를 가져와야 합니다
          let buyerPostcode = "13260"; // 실제로 사용자 정보를 가져와야 합니다

          if (!$("input[name='payment-method']:checked").val()) {
              alert("결제 수단을 선택해주세요.");
              return;
          }

          if (!$("input[name='agreement1']").is(":checked") ||
              !$("input[name='agreement2']").is(":checked") ||
              !$("input[name='agreement3']").is(":checked") ||
              !$("input[name='final-agreement']").is(":checked")) {
              alert("모든 필수 동의 항목에 체크해주세요.");
              return;
          }

          IMP.init("imp41634154");

          IMP.request_pay({
              pg: 'kcp',
              pay_method: 'card',
              merchant_uid: 'merchant_' + new Date().getTime(),
              name: orderName,
              amount: totalAmount,
              buyer_email: buyerEmail,
              buyer_name: buyerName,
              buyer_tel: buyerTel,
              buyer_addr: buyerAddr,
              buyer_postcode: buyerPostcode
          }, function (rsp) {
              if (rsp.success) {
                  alert("결제가 완료되었습니다.\n고유ID: " + rsp.imp_uid);

                  $.ajax({
                      url: "/order",
                      type: "POST",
                      contentType: "application/json",
                      data: JSON.stringify({
                          imp_uid: rsp.imp_uid,
                          merchant_uid: rsp.merchant_uid,
                          paid_amount: rsp.paid_amount,
                          buyer_name: rsp.buyer_name,
                          buyer_email: rsp.buyer_email,
                          buyer_tel: rsp.buyer_tel,
                          buyer_addr: rsp.buyer_addr,
                          buyer_postcode: rsp.buyer_postcode,
                          products: selectedItems
                      }),
                      success: function () {
                          location.href = "/order/success";
                      },
                      error: function () {
                          alert("결제 정보 전송 중 오류가 발생했습니다.");
                      }
                  });
              } else {
                  alert("결제에 실패하였습니다. 실패사유: " + rsp.error_msg);
              }
          });
      });
  });
    
        // 수량 변경 이벤트
        $(document).on("change", ".quantity-input", function () {
            const cartId = $(this).data("cart-id");
            const newQuantity = $(this).val();
            $.ajax({
                url: "/cart/update",
                type: 'PUT',
                contentType: "application/json",
                data: JSON.stringify({ cartId: cartId, quantity: newQuantity }),
                success: function () {
                    alert("수량이 업데이트되었습니다.");
                    location.reload(); // 업데이트 후 페이지 새로고침
                },
                error: function () {
                    alert("수량 업데이트 중 오류가 발생했습니다.");
                }
            });
        });
    
        // 삭제 버튼 클릭 이벤트
        $(document).on("click", ".delete-item-button", function () {
            const cartId = $(this).data("cart-id");
            $.ajax({
                url: `/cart/delete/${cartId}`,
                type: 'DELETE',
                success: function () {
                    alert("상품이 삭제되었습니다.");
                    location.reload(); // 삭제 후 페이지 새로고침
                },
                error: function () {
                    alert("상품 삭제 중 오류가 발생했습니다.");
                }
            });
        });
    
    function openAddressRegistration() {
        window.open('/order/addAddress', '주소 등록', 'width=500,height=700');
    }
    </script>
  </th:block>
</body>
</html>
