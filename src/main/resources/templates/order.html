<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="common/layout/base">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Page</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    *  {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      border: none;
      text-decoration: none;
      background: none;
  
      -webkit-font-smoothing: antialiased;
  }
  
  menu, ol, ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
  }
    .order-container {
      padding: 0px 280px 140px 280px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      flex: 1;
    }


    .order-title {
      color: #101010;
      text-align: center;
      font-family: "Inter-Regular", sans-serif;
      font-size: 20px;
      line-height: 34px;
      font-weight: 400;
      width: 100%;
      margin: 40px 0; /* 제목이 최상단에 위치하도록 여백 추가 */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .recipient-info-section {
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: flex-start;
      justify-content: flex-start;
      width: 100%;
      flex-shrink: 0;
      position: relative;
    }
    .section-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #101010;
    }
    .section-header2 {
      border-top: 1px solid #101010;
      padding: 20px 0;
      margin-bottom: 20px;

    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
    }
    .info-table {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .info-row {
      display: flex;
      gap: 40px;
      align-items: center;
    }
    .info-row2 {
      display: flex;
      gap: 40px;
      align-items: center;
      border: 0px 0px 20px 0px;
    }
    .memo-list {
      gap: 10px;
    }
    .info-label {
      width: 70px;
      font-size: 14px;
    }
    .input-field {
      border: 1px solid #cdcdcd;
      padding: 10px;
      border-radius: 3px;
      width: 300px;
    }
    .address-list {
      display: flex;
      gap: 20px;
    }
    .address-item {
      padding: 20px 0px;
      border-radius: 3px;
      width: 330px;
    }
    .product-info-section {
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    .product-container {
      display: flex;
      gap: 20px;
      flex-direction: column;
    }
    .product-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border: 1px solid #e6e6e6;
      border-radius: 5px;
      width: 100%;
    }
    .item-thumbnail {
      width: 77px;
      height: 102px;
    }
    .item-thumbnail img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 5px;
    }
    .item-description {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .brand-name2 {
      color: #212529;
      font-size: 11px;
    }
    .product-name {
   font-size: 14px;
   color: #767676;
 }
    .item-price {
      font-weight: 700;
      font-size: 18px;
    }
    .payment-frame {
      width: 100%;
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: space-between;
      height: 130px;
    }
    .payment-method-item {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .summary-title {
      height: 30px;
    }
    .summary-value {
      color: #101010;
      font-family: "Inter-Regular", sans-serif;
      font-size: 25px;
      font-weight: 700;
      text-align: right;
    }
    .summary-table,
    .summary-row {
      gap: 20px;
    }
    .pay-button {
      background: #062236;
      border-radius: 54px;
      width: 324px;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
    }
    .button-text {
      color: #ffffff;
      font-family: "Inter-Regular", sans-serif;
      font-size: 16.203125px;
      line-height: 54px;
      font-weight: 400;
    }
    .agreement-list {
      display: flex;
      flex-direction: column; /* 위에서 아래로 정렬 */
      gap: 15px; /* 항목 간 간격 추가 */
    }
  </style>
</head>
<body>
  <th:block layout:fragment="content">
    <div class="order-container">
      <div class="order-title">
        <h2>결제/주문</h2>
      </div>
      <section class="recipient-info-section">
        <header class="section-header">
          <h2 class="section-title">받는 분 정보</h2>
        </header>
        <div class="info-table">
          <div class="info-row">
            <span class="label-title">배송지 정보</span>
            <button class="address-link" onclick="openAddressRegistration()">
              <span class="link-text">배송지를 등록하세요</span>
            </button>
          </div> 
        </div>
<!-- 추가된 입력 필드 -->
<div class="info-row">
  <div class="info-label">배송지명</div>
  <input type="text" id="buyer-address-name" class="input-field" value="" readonly>
</div>

<div class="info-row">
  <div class="info-label">받는 사람</div>
  <input type="text" id="buyer-recipient-name" class="input-field" value="" readonly>
</div>

<div class="info-row">
  <div class="info-label">휴대폰 번호</div>
  <input type="text" id="buyer-phone-number" class="input-field" value="" readonly>
</div>

<div class="info-row">
  <div class="info-label">주소</div>
  <input type="text" id="buyer-address" class="input-field" value="" readonly>
</div>

      <!-- 배송 메모 -->
      <div class="info-row2">
        <div class="info-label">배송 메모</div>
        <div class="info-data">
          <div class="memo-list">
            <label class="memo-item">
              <input type="radio" name="memo-option" class="memo-checkbox">
              <span class="memo-text">선택 안 함</span>
            </label>
            <label class="memo-item">
              <input type="radio" name="memo-option" class="memo-checkbox">
              <span class="memo-text">부재 시 경비실에 맡겨주세요</span>
            </label>
            <label class="memo-item">
              <input type="radio" name="memo-option" class="memo-checkbox">
              <span class="memo-text">부재 시 집 앞에 놔주세요</span>
            </label>
            <label class="memo-item">
              <input type="radio" name="memo-option" class="memo-checkbox">
              <span class="memo-text">부재 시 핸드폰으로 연락 바랍니다</span>
            </label>
            <label class="memo-item">
              <input type="radio" name="memo-option" class="memo-checkbox">
              <span class="memo-text">배송 전 연락 바랍니다</span>
            </label>
          </div>
        </div>
      </div>
  </section>
      <section class="product-info-section">
        <header class="section-header">
          <h2 class="section-title">상품 정보</h2>
        </header>
        <div class="product-container" id="product-list">
          <!-- 상품 목록이 동적으로 추가될 부분 -->
        </div>     
      </section>
      <section class="payment-frame">
        <header class="section-header2">
          <h2 class="section-title">결제수단 선택</h2>
        </header>
        <div class="payment-method-list">
          <label class="payment-method-item">
            <input type="radio" name="payment-method" class="method-radio" value="card">
            <img src="/images/icon/card-image.png" alt="Credit/Debit Card" class="method-icon">
            <span class="method-title">신용/체크카드</span>
          </label>
        </div>
        <header class="section-header2">
          <h2 class="section-title">최종 결제금액</h2>
        </header>
        <section class="total-payment-section">
          <div class="agreement-list">
                <label class="agreement-item">
                  <input type="checkbox" name="agreement1" class="agreement-checkbox">
                  <span class="agreement-text">주문상품정보 및 서비스 이용약관에 동의</span>
                </label>
                <label class="agreement-item">
                  <input type="checkbox" name="agreement2" class="agreement-checkbox">
                  <span class="agreement-text">구매조건 확인 및 결제 진행 동의(필수)</span>
                </label>
                <label class="agreement-item">
                  <input type="checkbox" name="agreement3" class="agreement-checkbox">
                  <span class="agreement-text">개인정보 제 3자 제공 동의(필수)</span>
                  <button class="details-button">자세히</button>
                </label>
                <label class="final-agreement">
                  <input type="checkbox" name="final-agreement" class="agreement-checkbox">
                  <span class="agreement-text">위 주문 내용을 확인하였으며, 결제에 모두 동의합니다</span>
                </label>
          </div>
        </section>
      </section>
      <div class="summary-row">
        <span class="summary-title">최종 결제금액</span>
        <span class="summary-value">0원</span>
      </div>
        <button class="pay-button" id="pay-button">
          결제하기
        </button>
    </div>
  </th:block>
  <th:block layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script>
      // Order page script
      $(document).ready(function () {
          const orderData = JSON.parse(localStorage.getItem('orderData'));
          const addressData = JSON.parse(localStorage.getItem('addressData'));
    
          if (!orderData || orderData.items.length === 0) {
              alert("주문 정보가 없습니다.");
              return;
          }
    
          if (addressData) {
              $("#buyer-address-name").val(addressData.addressName);
              $("#buyer-recipient-name").val(addressData.recipientName);
              $("#buyer-phone-number").val(addressData.phoneNumber);
              $("#buyer-address").val(addressData.fullAddress);
          }
    
          let totalAmount = orderData.totalPrice;
          let totalQuantity = orderData.totalQuantity;
    
          orderData.items.forEach(item => {
            $("#product-list").append(`
          
                    
                  <div class="product-item">
                      <div class="item-thumbnail">
                          <a href="/product/${item.productId}">
                              <img src="/images/products/0${item.productId}/${item.productId}_thumbnail.webp" alt="상품 써니얼" />
                          </a>
                      </div>
                      <div class="item-description">
                        <div class="brand-name2">${item.brandName}</div>
                        <div class="product-name">${item.productName}</div>
                        <div class="product-variant">${item.quantity}개</div>
                      </div>
                      <div class="item-price">
                          <strong>${(item.price).toLocaleString()}원</strong>
                      </div>
                  </div>
              `);
          });
    
          $(".summary-value").text(totalAmount.toLocaleString() + "원");
          $("#pay-button").text(`총 ${totalQuantity}개 / ${totalAmount.toLocaleString()}원 결제하기`);
    
          $("#pay-button").click(function () {
              console.log("결제하기 버튼 클릭됨");
    
              let orderName = orderData.items[0].productName;
              let buyerName = $("#buyer-recipient-name").val();
              let buyerTel = $("#buyer-phone-number").val();
              let buyerAddr = $("#buyer-address").val();
    
              if (!$("input[name='payment-method']:checked").val()) {
                  alert("결제 수단을 선택해주세요.");
                  return;
              }
    
              if (!$("input[name='agreement1']").is(":checked") ||
                  !$("input[name='agreement2']").is(":checked") ||
                  !$("input[name='agreement3']").is(":checked") ||
                  !$("input[name='final-agreement']").is(":checked")) {
                  alert("모든 필수 동의 항목에 체크해주세요.");
                  return;
              }
    
              IMP.init("imp41634154");
    
              IMP.request_pay({
                  pg: 'kcp',
                  pay_method: 'card',
                  merchant_uid: 'merchant_' + new Date().getTime(),
                  name: orderName,
                  amount: totalAmount,
                  buyer_name: buyerName,
                  buyer_tel: buyerTel,
                  buyer_addr: buyerAddr
              }, function (rsp) {
                  if (rsp.success) {
                      alert("결제가 완료되었습니다.\n고유ID: " + rsp.imp_uid);
    
                      $.ajax({
                          url: "/order",
                          type: "POST",
                          contentType: "application/json",
                          data: JSON.stringify({
                              imp_uid: rsp.imp_uid,
                              merchant_uid: rsp.merchant_uid,
                              paid_amount: rsp.paid_amount,
                              buyer_name: rsp.buyer_name,
                              buyer_tel: rsp.buyer_tel,
                              buyer_addr: rsp.buyer_addr,
                              products: orderData.items
                          }),
                          success: function () {
                              location.href = "/orderComplete";
                          },
                          error: function () {
                              alert("결제 정보 전송 중 오류가 발생했습니다.");
                          }
                      });
                  } else {
                      alert("결제에 실패했습니다. 실패사용: " + rsp.error_msg);
                  }
              });
          });
      });
    
      function openAddressRegistration() {
          window.open('/order/addAddress', '주소 등록', 'width=500,height=700');
    
          window.addEventListener("message", function(event) {
              if (event.data.type === "address") {
                  const addressData = event.data.address;
                  localStorage.setItem("addressData", JSON.stringify(addressData));
                  $("#buyer-address-name").val(addressData.addressName);
                  $("#buyer-recipient-name").val(addressData.recipientName);
                  $("#buyer-phone-number").val(addressData.phoneNumber);
                  $("#buyer-address").val(addressData.fullAddress);
              }
          }, false);
      }
    </script>    
  </th:block>
</body>
</html>
