<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="common/layout/base"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Page</title>
  <style>
    body {
      input:focus {
        outline: none;
      }
    }
    .main-container,
    .main-container * {
      box-sizing: border-box;
    }
    .main-container {
      padding: 0px 280px 140px 280px;
      display: flex;
      flex-direction: column;
      gap: 0px;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      flex: 1;
    }
    .order-title {
      color: #101010;
      text-align: center;
      font-family: "Inter-Regular", sans-serif;
      font-size: 20px;
      line-height: 34px;
      font-weight: 400;
      width: 100%;
      margin: 40px 0; /* 제목이 최상단에 위치하도록 여백 추가 */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .recipient-info-section {
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: flex-start;
      justify-content: flex-start;
      align-self: stretch;
      flex-shrink: 0;
      position: relative;
    }
    .section-header {
      border-top: 1px solid #101010;
      border-style: solid;
      border-image: linear-gradient(
        0deg,
        rgba(238, 238, 238, 1) 0%,
        rgba(16, 16, 16, 1) 0%
      );
      border-image-slice: 1;
      padding: 21px 5px 22px 5px;
      display: flex;
      flex-direction: column;
      gap: 0px;
      align-items: flex-start;
      justify-content: flex-start;
      align-self: stretch;
      flex-shrink: 0;
      position: relative;
    }
    .section-title {
      color: #101010;
      text-align: left;
      font-family: "Inter-Regular", sans-serif;
      font-size: 18.75px;
      line-height: 28px;
      font-weight: 400;
      position: relative;
      align-self: stretch;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    .product-info-section {
      display: flex;
      flex-direction: column;
      gap: 0px;
      align-items: flex-start;
      justify-content: flex-start;
      align-self: stretch;
      flex-shrink: 0;
      position: relative;
    }
    .product-container {
      display: flex;
      flex-direction: column;
      gap: 0px;
      align-items: flex-start;
      justify-content: flex-start;
      align-self: stretch;
      flex-shrink: 0;
      position: relative;
      border-top: 1px solid #101010;
    }
    .product-item {
      align-self: stretch;
      flex-shrink: 0;
      height: 150px;
      position: relative;
    }
    .product-image {
      width: 77px;
      height: 102px;
      object-fit: cover;
    }
    .like-button {
      padding: 10px 10px 12.25px 10px;
      left: -10px;
      top: 0px;
    }
    .like-icon {
      width: 18px;
      height: 15.75px;
      overflow: visible;
    }
    .payment-frame {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: space-between;
      height: 200px;
    }
    .summary-title {
      height: 30px;
    }
    .summary-value {
      color: #101010;
      font-family: "Inter-Regular", sans-serif;
      font-size: 25px;
    }
    .summary-value {
      font-weight: 700;
      text-align: right;
      font-size: 25px;
    }
    .summary-row {
      gap: 15px;
    }
    .pay-button {
      background: #062236;
      border-radius: 54px;
      width: 324px;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
    }
    .button-text {
      color: #ffffff;
      font-family: "Inter-Regular", sans-serif;
      font-size: 16.203125px;
      line-height: 54px;
      font-weight: 400;
    }
    .agreement-list {
      display: flex;
      flex-direction: column; /* 위에서 아래로 정렬 */
      gap: 15px; /* 항목 간 간격 추가 */
    }
  </style>
</head>
<body>
  <th:block layout:fragment="content">
  <div class="main-container">
    <div class="order-title">
      <h2>결제/주문</h2>
    </div>
    <section class="recipient-info-section">
      <header class="section-header">
        <h2 class="section-title">받는 분 정보</h2>
      </header>
      <div class="info-table">
        <div class="info-body">
          <div class="info-row">
            <div class="info-label">이메일 주소</div>
            <div class="info-data">
              <div class="input-container">
                <input type="text" class="input-field" th:value="${user.email}" readonly />
              </div>
            </div>
          </div>
          <div class="info-row">
            <div class="info-label">
              <span class="label-title">배송지 정보</span>
              <span th:text="${user.addresses != null ? #lists.size(user.addresses) + '개' : '0개'}" class="item-count"></span>
            </div>
            <div class="info-data">
              <div class="address-list">
                <div th:if="${user.addresses == null || #lists.isEmpty(user.addresses)}">
                  <div class="address-item">
                    <button class="address-link" onclick="openAddressRegistration()">
                      <span class="link-text">배송지를 등록하세요</span>
                    </button>
                  </div>
                </div>
                <div th:each="address : ${user.addresses}" class="address-item">
                  <div class="address-details">
                    <div class="address-info">
                      <div class="address-title">
                        <span th:text="${address.label}">집</span>
                      </div>
                      <div class="recipient-details">
                        <span th:text="${user.userName} + ' / ' + ${user.phone}">이름 / 전화번호</span>
                      </div>
                      <div class="address-text">
                        <span th:text="${address.fullAddress}">주소 정보</span>
                      </div>
                    </div>
                    <button class="action-button">수정</button>
                    <span class="recent-address-label" th:if="${address.isRecent}">최근배송지</span>
                  </div>
                  <button class="delete-button">삭제</button>
                </div>
              </div>
            </div>
          </div>
          <div class="info-row">
            <div class="info-label">배송 메모</div>
            <div class="info-data">
              <div class="memo-list">
                <label class="memo-item">
                  <input type="radio" name="memo-option" class="memo-checkbox" />
                  <span class="memo-text">선택 안 함</span>
                </label>
                <!-- 추가 옵션들 -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="product-info-section">
      <header class="section-header">
        <h2 class="section-title">상품 정보</h2>
      </header>
      <div class="product-container">
        <div th:each="item : ${selectedItems}">
          <div class="product-item">
              <img th:src="@{/images/product/look1/productThumbnail.jpg}" alt="Product Thumbnail" class="product-image" />
              <div class="product-details">
                  <h3 th:text="${item.productName}" class="brand-name"></h3>
                  <p th:text="${item.quantity} + '개'" class="product-variant"></p>
              </div>
              <div class="product-price" th:text="${item.productPrice} + '원'"></div>
          </div>
        </div>      
      </div>
    </section>

    <section class="payment-frame">
      <!-- 결제 관련 정보 -->
      <div class="summary-row">
        <span class="summary-title">최종 결제금액</span>
        <span class="summary-value" th:text="${totalPrice} + '원'"></span>
        <button class="pay-button" id="pay-button">결제하기</button>
      </div>
    </section>
  </div>
  </th:block>

  <th:block layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script>
      $(document).ready(function () {
        console.log("jQuery 로드 성공");

        $("#pay-button").click(function () {
          console.log("결제하기 버튼 클릭됨");

          let selectedItems = [];
          let totalAmount = 0;

          $(".product-item").each(function () {
            const productName = $(this).find(".brand-name").text().trim();
            const productPrice = parseInt($(this).find(".product-price").text().replace(/\D/g, ""));
            const quantity = parseInt($(this).find(".product-variant").text().replace(/\D/g, ""));

            totalAmount += productPrice * quantity;

            selectedItems.push({
              productName: productName,
              productPrice: productPrice,
              quantity: quantity
            });
          });

          if (!$("input[name='payment-method']:checked").val()) {
            alert("결제 수단을 선택해주세요.");
            return;
          }

          if (!$("input[name='agreement1']").is(":checked") ||
              !$("input[name='agreement2']").is(":checked") ||
              !$("input[name='agreement3']").is(":checked") ||
              !$("input[name='final-agreement']").is(":checked")) {
            alert("모든 필수 동의 항목에 체크해주세요.");
            return;
          }

          IMP.init("imp41634154");

          IMP.request_pay({
            pg: 'kcp',
            pay_method: 'card',
            merchant_uid: 'merchant_' + new Date().getTime(),
            name: selectedItems[0].productName,
            amount: totalAmount,
            buyer_email: $("#buyer-email").val(),
            buyer_name: $("#buyer-name").val(),
            buyer_tel: $("#buyer-tel").val(),
            buyer_addr: $("#buyer-address").val(),
            buyer_postcode: $("#buyer-postcode").val()
          }, function (rsp) {
            if (rsp.success) {
              alert("결제가 완료되었습니다.\n고유ID: " + rsp.imp_uid);
              $.ajax({
                url: "/order/complete",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                  imp_uid: rsp.imp_uid,
                  merchant_uid: rsp.merchant_uid,
                  paid_amount: rsp.paid_amount,
                  products: selectedItems
                }),
                success: function () {
                  location.href = "/order/success";
                },
                error: function () {
                  alert("결제 정보 전송 중 오류가 발생했습니다.");
                }
              });
            } else {
              alert("결제에 실패하였습니다. 실패사유: " + rsp.error_msg);
            }
          });
        });
      });

      function openAddressRegistration() {
        window.open('/order/addAddress', '주소 등록', 'width=500,height=700');
      }
    </script>
  </th:block>
</body>
</html>